<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¼šè®¡å­¦åŸç†Â·ç¬¬ä¸€ç« åˆ†å—ç»ƒä¹ </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; }
        body { background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #3949ab 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; width: 100%; margin: 0 auto; }
        .main-card { background-color: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); overflow: hidden; padding: 30px; margin-bottom: 20px; }
        header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px dashed #3949ab; }
        h1 { color: #1a237e; margin-bottom: 10px; font-size: 2.2rem; }
        .subtitle { color: #5c6bc0; font-size: 1.1rem; }
        .game-info { display: flex; justify-content: space-around; background: #e8eaf6; padding: 20px; border-radius: 15px; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .info-item { text-align: center; flex: 1; min-width: 140px; }
        .info-label { font-size: 0.9rem; color: #5c6bc0; margin-bottom: 5px; }
        .info-value { font-size: 2rem; font-weight: bold; color: #1a237e; }
        .screen { display: none; animation: fadeIn 0.5s ease; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .module-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin: 30px 0; }
        .module-card { background: linear-gradient(135deg, #e8eaf6, #c5cae9); border-radius: 15px; padding: 25px; cursor: pointer; transition: all 0.3s; border: 3px solid transparent; }
        .module-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); }
        .module-card.completed { border-color: #4caf50; background: linear-gradient(135deg, #e8f5e9, #c8e6c9); }
        .module-card.current { border-color: #ff9800; box-shadow: 0 0 20px rgba(255, 152, 0, 0.4); }
        .module-card.in-progress { border-color: #2196f3; background: linear-gradient(135deg, #e3f2fd, #bbdefb); }
        .module-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .module-title { font-size: 1.3rem; font-weight: bold; color: #1a237e; margin-bottom: 10px; }
        .module-desc { font-size: 0.9rem; color: #5c6bc0; margin-bottom: 15px; }
        .module-progress { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; color: #1a237e; }
        .module-progress-bar { flex: 1; height: 8px; background: #fff; border-radius: 4px; overflow: hidden; }
        .module-progress-fill { height: 100%; background: linear-gradient(to right, #00c853, #64dd17); transition: width 0.5s ease; }
        .module-status { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; margin-left: 10px; }
        .status-pending { background: #e0e0e0; color: #666; }
        .status-progress { background: #2196f3; color: white; }
        .status-completed { background: #4caf50; color: white; }
        .question { background: #f5f7ff; border-left: 5px solid #3949ab; padding: 20px; border-radius: 0 10px 10px 0; margin: 20px 0; }
        .question-title { font-weight: bold; margin-bottom: 15px; color: #1a237e; font-size: 1.1rem; }
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option { background: white; border: 2px solid #c5cae9; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; }
        .option:hover { background: #e8eaf6; border-color: #7986cb; }
        .option.selected { background: #e3f2fd; border-color: #2196f3; }
        .option.correct { background: #e8f5e9; border-color: #4caf50; }
        .option.incorrect { background: #ffebee; border-color: #f44336; }
        .option.answered { opacity: 0.6; cursor: not-allowed; background: #f5f5f5; }
        .option-prefix { display: inline-block; width: 28px; height: 28px; line-height: 28px; text-align: center; background: #3949ab; color: white; border-radius: 50%; margin-right: 12px; font-weight: bold; flex-shrink: 0; }
        .feedback { padding: 20px; background: #e8eaf6; border-radius: 10px; margin-top: 20px; display: none; }
        .feedback.show { display: block; animation: fadeIn 0.5s ease; }
        .controls { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 1px solid #c5cae9; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .btn i { font-size: 1.1rem; }
        .btn-primary { background: linear-gradient(to right, #3949ab, #283593); color: white; }
        .btn-primary:hover:not(:disabled) { background: linear-gradient(to right, #303f9f, #1a237e); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .btn-secondary { background: #e0e0e0; color: #424242; }
        .btn-secondary:hover:not(:disabled) { background: #bdbdbd; }
        .btn-success { background: linear-gradient(to right, #43a047, #2e7d32); color: white; }
        .btn-success:hover:not(:disabled) { background: linear-gradient(to right, #388e3c, #1b5e20); transform: translateY(-2px); }
        .btn:disabled { background: #bdbdbd; cursor: not-allowed; transform: none; box-shadow: none; }
        .leaderboard-container { background: #fff8e1; border-radius: 15px; padding: 25px; margin-top: 20px; }
        .leaderboard-tabs { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }
        .leaderboard-tab { padding: 8px 16px; background: white; border: 2px solid #c5cae9; border-radius: 20px; cursor: pointer; transition: all 0.3s; font-weight: bold; color: #5c6bc0; }
        .leaderboard-tab:hover { background: #e8eaf6; }
        .leaderboard-tab.active { background: #3949ab; color: white; border-color: #3949ab; }
        .leaderboard-table { width: 100%; border-collapse: collapse; }
        .leaderboard-table th { background: #1a237e; color: white; padding: 12px; text-align: center; }
        .leaderboard-table th:first-child { border-radius: 10px 0 0 10px; }
        .leaderboard-table th:last-child { border-radius: 0 10px 10px 0; }
        .leaderboard-table td { padding: 12px; text-align: center; border-bottom: 1px solid #e0e0e0; }
        .leaderboard-table tr:hover { background: #f5f5f5; }
        .rank-1 { background: linear-gradient(to right, #ffd700, #ffeb3b) !important; font-weight: bold; }
        .rank-2 { background: linear-gradient(to right, #c0c0c0, #e0e0e0) !important; }
        .rank-3 { background: linear-gradient(to right, #cd7f32, #d4a574) !important; }
        .my-rank { background: #4caf50 !important; color: white; font-weight: bold; }
        .name-input-container { text-align: center; padding: 40px 20px; }
        .name-input-container h2 { margin-bottom: 20px; color: #1a237e; }
        .name-input-container p { margin-bottom: 25px; color: #5c6bc0; }
        .name-input { width: 100%; max-width: 350px; padding: 15px 20px; font-size: 1.2rem; border: 3px solid #c5cae9; border-radius: 10px; text-align: center; outline: none; transition: border-color 0.3s; }
        .name-input:focus { border-color: #3949ab; }
        .matching-container { display: flex; flex-direction: column; gap: 15px; }
        .matching-row { display: flex; align-items: center; gap: 15px; flex-wrap: wrap; }
        .matching-left { flex: 1; min-width: 200px; background: white; border: 2px solid #c5cae9; border-radius: 8px; padding: 12px 15px; font-weight: bold; color: #1a237e; }
        .matching-arrow { font-size: 1.5rem; color: #5c6bc0; }
        .matching-select { flex: 1; min-width: 200px; padding: 12px; border: 2px solid #c5cae9; border-radius: 8px; background: white; color: #1a237e; font-weight: bold; cursor: pointer; }
        .matching-select:disabled { background: #f5f5f5; cursor: not-allowed; }
        .matching-select:focus { outline: none; border-color: #3949ab; }
        .fill-blank { display: inline-block; min-width: 120px; padding: 8px 15px; border: 2px solid #c5cae9; border-radius: 5px; font-size: 1rem; text-align: center; margin: 0 8px; }
        .fill-blank:disabled { background: #f5f5f5; cursor: not-allowed; }
        .fill-blank:focus { outline: none; border-color: #3949ab; }
        .progress-section { margin: 20px 0; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; color: #1a237e; }
        .progress-bar { height: 12px; background: #c5cae9; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(to right, #00c853, #64dd17); width: 0%; transition: width 0.5s ease; }
        .module-complete { text-align: center; padding: 40px 20px; }
        .module-complete-icon { font-size: 4rem; color: #4caf50; margin-bottom: 20px; }
        .module-complete h2 { color: #1a237e; margin-bottom: 15px; }
        .module-complete-stats { display: flex; justify-content: center; gap: 40px; margin: 25px 0; flex-wrap: wrap; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #1a237e; }
        .stat-label { color: #5c6bc0; font-size: 0.9rem; }

        /* ä¸»è§‚é¢˜æ ·å¼ */
        .essay-answer { width: 100%; min-height: 120px; padding: 15px; border: 2px solid #c5cae9; border-radius: 8px; font-family: inherit; font-size: 1rem; margin-top: 10px; resize: vertical; line-height: 1.6; }
        .essay-answer:disabled { background: #f5f5f5; cursor: not-allowed; }
        .essay-answer:focus { outline: none; border-color: #3949ab; }
        .reference-answer { background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ff9800; }
        .reference-answer h4 { color: #e65100; margin-bottom: 10px; }
        .data-summary { background: #fff8e1; padding: 20px; border-radius: 10px; margin: 20px 0; border-left: 5px solid #ffb300; }
        .data-summary h4 { margin-bottom: 10px; color: #f57c00; }
        .data-summary ul { margin: 10px 0 10px 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-card">
            <header>
                <h1><i class="fas fa-book-open"></i> ä¼šè®¡å­¦åŸç†Â·ç¬¬ä¸€ç« åˆ†å—ç»ƒä¹ </h1>
                <p class="subtitle">ç´¯è®¡100åˆ† Â· å®æ—¶æ’è¡Œæ¦œ Â· è¿›åº¦è‡ªåŠ¨ä¿å­˜</p>
            </header>

            <div class="game-info" id="game-info" style="display: none;">
                <div class="info-item"><div class="info-label">ç©å®¶</div><div class="info-value" id="player-name-display">-</div></div>
                <div class="info-item"><div class="info-label">ç´¯è®¡å¾—åˆ†</div><div class="info-value"><span id="total-score">0</span><span style="font-size: 1rem;">/100</span></div></div>
                <div class="info-item"><div class="info-label">ç­”å¯¹é¢˜æ•°</div><div class="info-value"><span id="correct-count">0</span>/<span id="total-questions-count">24</span></div></div>
                <div class="info-item"><div class="info-label">å½“å‰æ’å</div><div class="info-value" id="current-rank">-</div></div>
            </div>

            <div class="screen active" id="screen-welcome">
                <div class="name-input-container">
                    <h2><i class="fas fa-user-circle"></i> æ¬¢è¿æ¥åˆ°ä¼šè®¡å­¦åŸç†ç»ƒä¹ </h2>
                    <p>è¯·è¾“å…¥ä½ çš„å§“åå¼€å§‹ç»ƒä¹ ã€‚ä½ çš„æˆç»©å°†å®æ—¶æ˜¾ç¤ºåœ¨æ’è¡Œæ¦œä¸Šã€‚</p>
                    <input type="text" class="name-input" id="player-name" placeholder="è¯·è¾“å…¥ä½ çš„å§“å" maxlength="20">
                    <div class="controls"><button class="btn btn-primary" id="start-game" style="margin: 0 auto;"><i class="fas fa-play"></i> å¼€å§‹ç»ƒä¹ </button></div>
                    <div style="margin-top: 20px; color: #888; font-size: 0.9rem;"><i class="fas fa-info-circle"></i> å…±24é¢˜ï¼ˆå«2é“ä¸»è§‚é¢˜ï¼‰ï¼Œç´¯è®¡100åˆ†ï¼Œç­”é¢˜è¿›åº¦è‡ªåŠ¨ä¿å­˜</div>
                </div>
            </div>

            <div class="screen" id="screen-modules">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-th-large"></i> é€‰æ‹©ç»ƒä¹ æ¨¡å—</h2>
                <p style="color: #666; margin-bottom: 20px;">å®Œæˆä»»æ„æ¨¡å—çš„é¢˜ç›®å³å¯ä¸Šæ¦œï¼ŒæŒ‰ç´¯è®¡æ€»åˆ†æ’å</p>
                <div class="module-grid" id="module-grid"></div>
                <div class="controls">
                    <button class="btn btn-secondary" id="view-leaderboard-btn"><i class="fas fa-trophy"></i> æŸ¥çœ‹æ’è¡Œæ¦œ</button>
                    <button class="btn btn-success" id="export-essay-btn"><i class="fas fa-file-alt"></i> å¯¼å‡ºä¸»è§‚é¢˜ç­”æ¡ˆ</button>
                </div>
            </div>

            <div class="screen" id="screen-question">
                <div class="progress-section">
                    <div class="progress-label"><span id="question-progress">é¢˜ç›® 1/6</span><span id="module-progress">æ¨¡å—è¿›åº¦</span></div>
                    <div class="progress-bar"><div class="progress-fill" id="question-progress-bar"></div></div>
                </div>
                <div id="question-container"></div>
                <div class="feedback" id="feedback">
                    <div class="feedback-title"><i class="fas fa-comment-dots"></i> ç­”é¢˜åé¦ˆ</div>
                    <div id="feedback-text"></div>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" id="back-to-modules"><i class="fas fa-arrow-left"></i> è¿”å›æ¨¡å—ï¼ˆè¿›åº¦è‡ªåŠ¨ä¿å­˜ï¼‰</button>
                    <button class="btn btn-secondary" id="prev-question" style="display: none;"><i class="fas fa-arrow-left"></i> ä¸Šä¸€é¢˜</button>
                    <button class="btn btn-success" id="resume-question" style="display: none;">ç»§ç»­ç­”é¢˜ <i class="fas fa-play"></i></button>
                    <button class="btn btn-primary" id="submit-answer"><i class="fas fa-check"></i> æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-success" id="next-question" style="display: none;">ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>

            <div class="screen" id="screen-module-complete">
                <div class="module-complete">
                    <div class="module-complete-icon"><i class="fas fa-check-circle"></i></div>
                    <h2>æ¨¡å—å®Œæˆï¼</h2>
                    <p id="module-complete-message">æ­å–œä½ å®Œæˆæœ¬æ¨¡å—ç»ƒä¹ </p>
                    <div class="module-complete-stats">
                        <div class="stat-item"><div class="stat-value" id="module-score">0</div><div class="stat-label">æœ¬æ¨¡å—å¾—åˆ†</div></div>
                        <div class="stat-item"><div class="stat-value" id="module-correct">0/0</div><div class="stat-label">ç­”å¯¹é¢˜æ•°</div></div>
                        <div class="stat-item"><div class="stat-value" id="module-points">0</div><div class="stat-label">è·å¾—ç§¯åˆ†</div></div>
                    </div>
                    <div class="controls" style="justify-content: center;">
                        <button class="btn btn-secondary" id="back-to-modules-complete"><i class="fas fa-arrow-left"></i> è¿”å›æ¨¡å—é€‰æ‹©</button>
                        <button class="btn btn-primary" id="view-leaderboard-complete"><i class="fas fa-trophy"></i> æŸ¥çœ‹æ’è¡Œæ¦œ</button>
                    </div>
                </div>
            </div>

            <div class="screen" id="screen-leaderboard">
                <h2 style="margin-bottom: 20px;"><i class="fas fa-trophy"></i> å®æ—¶æ’è¡Œæ¦œ</h2>
                <div class="leaderboard-container">
                    <div class="leaderboard-tabs">
                        <div class="leaderboard-tab active" data-tab="total">æ€»åˆ†æ’å</div>
                        <div class="leaderboard-tab" data-tab="module1">æ¨¡å—1</div>
                        <div class="leaderboard-tab" data-tab="module2">æ¨¡å—2</div>
                        <div class="leaderboard-tab" data-tab="module3">æ¨¡å—3</div>
                        <div class="leaderboard-tab" data-tab="module4">æ¨¡å—4</div>
                        <div class="leaderboard-tab" data-tab="module5">æ¨¡å—5</div>
                        <div class="leaderboard-tab" data-tab="module6">æ¨¡å—6</div>
                    </div>
                    <div id="leaderboard-content">
                        <table class="leaderboard-table">
                            <thead><tr><th>æ’å</th><th>å§“å</th><th>ç´¯è®¡å¾—åˆ†</th><th>ç­”å¯¹/æ€»é¢˜æ•°</th><th>å®Œæˆæ¨¡å—</th><th>æ—¶é—´</th></tr></thead>
                            <tbody id="leaderboard-body"><tr><td colspan="6" style="padding: 30px; color: #999;">æš‚æ— æ’åæ•°æ®</td></tr></tbody>
                        </table>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-secondary" id="back-from-leaderboard"><i class="fas fa-arrow-left"></i> è¿”å›</button>
                    <button class="btn btn-primary" id="export-leaderboard"><i class="fas fa-download"></i> å¯¼å‡ºæ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modules = [
            {
                id: 1, title: "æ¨¡å—1ï¼šä¼šè®¡å«ä¹‰ã€èŒèƒ½ä¸ç›®æ ‡", description: "ä¼šè®¡çš„åŸºæœ¬èŒèƒ½ã€ç›®æ ‡ã€ä¿¡æ¯ä½¿ç”¨è€…", icon: "fa-book",
                questions: [
                    { type: "choice", question: "ä¼šè®¡çš„åŸºæœ¬èŒèƒ½æ˜¯ä»€ä¹ˆï¼Ÿ", options: ["é¢„æµ‹å’Œå†³ç­–", "æ ¸ç®—å’Œç›‘ç£", "è®¡åˆ’å’Œåˆ†æ", "æ§åˆ¶å’Œè€ƒè¯„"], answer: "B", explanation: "æˆ‘å›½ã€Šä¼šè®¡æ³•ã€‹è§„å®šï¼Œä¼šè®¡çš„åŸºæœ¬èŒèƒ½æ˜¯æ ¸ç®—å’Œç›‘ç£ã€‚" },
                    { type: "choice", question: "ä¸‹åˆ—å“ªé¡¹ä¸å±äºä¼šè®¡ä¿¡æ¯çš„ä½¿ç”¨è€…ï¼Ÿ", options: ["è‚¡ä¸œå’ŒæŠ•èµ„è€…", "ä¼ä¸šç®¡ç†å½“å±€", "ç«äº‰å¯¹æ‰‹", "å€ºæƒäºº"], answer: "C", explanation: "ä¼šè®¡ä¿¡æ¯ä½¿ç”¨è€…åŒ…æ‹¬è‚¡ä¸œã€ç®¡ç†å½“å±€ã€å€ºæƒäººã€å®¢æˆ·ã€ä¾›åº”å•†ã€æ”¿åºœã€å‘˜å·¥ç­‰ï¼Œç«äº‰å¯¹æ‰‹ä¸æ˜¯ä¸»è¦ä½¿ç”¨è€…ã€‚" },
                    { type: "choice", question: "'å†³ç­–æœ‰ç”¨è§‚'å¼ºè°ƒä¼šè®¡ä¿¡æ¯çš„ä»€ä¹ˆç‰¹å¾ï¼Ÿ", options: ["å¯é æ€§", "ç›¸å…³æ€§", "è°¨æ…æ€§", "å¯æ¯”æ€§"], answer: "B", explanation: "å†³ç­–æœ‰ç”¨è§‚å¼ºè°ƒä¼šè®¡ä¿¡æ¯å¯¹å†³ç­–æœ‰ç”¨ï¼Œå› æ­¤æ›´å¼ºè°ƒç›¸å…³æ€§ã€‚" },
                    { type: "choice", question: "ä¼šè®¡æ ¸ç®—èŒèƒ½æ˜¯ä¼šè®¡çš„é¦–è¦èŒèƒ½ã€‚", options: ["æ­£ç¡®", "é”™è¯¯"], answer: "A", explanation: "ä¼šè®¡æ ¸ç®—èŒèƒ½æ˜¯é¦–è¦èŒèƒ½ï¼Œæ˜¯ä¼šè®¡ç®¡ç†å·¥ä½œçš„åŸºç¡€ã€‚" },
                    { type: "choice", question: "å—æ‰˜è´£ä»»è§‚å¼ºè°ƒç›¸å…³æ€§ç”šäºå¯é æ€§ã€‚", options: ["æ­£ç¡®", "é”™è¯¯"], answer: "B", explanation: "å—æ‰˜è´£ä»»è§‚å¼ºè°ƒå¯é æ€§ï¼Œå†³ç­–æœ‰ç”¨è§‚æ‰å¼ºè°ƒç›¸å…³æ€§ã€‚" },
                    { type: "choice", question: "ABCå…¬å¸å‘é“¶è¡Œç”³è¯·è´·æ¬¾5,000ä¸‡å…ƒï¼Œé“¶è¡Œéœ€è¦å“ªäº›ä¿¡æ¯ï¼Ÿ", options: ["åªéœ€è¦ä¼ä¸šå•†ä¸šç§˜å¯†", "ä¼ä¸šçš„è´¢åŠ¡æŠ¥è¡¨ã€é¡¹ç›®å¯è¡Œæ€§ç ”ç©¶æŠ¥å‘Šç­‰", "åªéœ€è¦ä¼ä¸šè€æ¿çš„æ‰¿è¯º", "åªéœ€è¦ä¼ä¸šçš„å¹¿å‘Šå®£ä¼ "], answer: "B", explanation: "é“¶è¡Œéœ€è¦è¯„ä¼°ä¼ä¸šè´¢åŠ¡çŠ¶å†µã€å¿å€ºèƒ½åŠ›ã€é¡¹ç›®å‰æ™¯ç­‰ä¿¡æ¯ã€‚" }
                ]
            },
            {
                id: 2, title: "æ¨¡å—2ï¼šä¼šè®¡å¯¹è±¡å’Œä¼šè®¡è¦ç´ ", description: "å…­å¤§è¦ç´ ã€ä¼šè®¡ç­‰å¼", icon: "fa-cubes",
                questions: [
                    { type: "classify", question: "è¯·å°†ä¸‹åˆ—é¡¹ç›®å½’ç±»åˆ°æ­£ç¡®çš„ä¼šè®¡è¦ç´ ä¸­ï¼š", items: ["é“¶è¡Œå­˜æ¬¾", "åº”æ”¶è´¦æ¬¾", "åº”ä»˜è´¦æ¬¾", "å®æ”¶èµ„æœ¬", "é”€å”®æ”¶å…¥", "ç®¡ç†è´¹ç”¨"], categories: ["èµ„äº§", "è´Ÿå€º", "æ‰€æœ‰è€…æƒç›Š", "æ”¶å…¥", "è´¹ç”¨"], answer: {"é“¶è¡Œå­˜æ¬¾": "èµ„äº§", "åº”æ”¶è´¦æ¬¾": "èµ„äº§", "åº”ä»˜è´¦æ¬¾": "è´Ÿå€º", "å®æ”¶èµ„æœ¬": "æ‰€æœ‰è€…æƒç›Š", "é”€å”®æ”¶å…¥": "æ”¶å…¥", "ç®¡ç†è´¹ç”¨": "è´¹ç”¨"}, explanation: "èµ„äº§=é“¶è¡Œå­˜æ¬¾ã€åº”æ”¶è´¦æ¬¾ï¼›è´Ÿå€º=åº”ä»˜è´¦æ¬¾ï¼›æ‰€æœ‰è€…æƒç›Š=å®æ”¶èµ„æœ¬ï¼›æ”¶å…¥=é”€å”®æ”¶å…¥ï¼›è´¹ç”¨=ç®¡ç†è´¹ç”¨ã€‚" },
                    { type: "choice", question: "èµ„äº§=è´Ÿå€º+æ‰€æœ‰è€…æƒç›Š æ˜¯ä»€ä¹ˆç­‰å¼ï¼Ÿ", options: ["åŠ¨æ€ä¼šè®¡ç­‰å¼", "é™æ€ä¼šè®¡ç­‰å¼", "ç»¼åˆä¼šè®¡ç­‰å¼", "æ‰©å±•ä¼šè®¡ç­‰å¼"], answer: "B", explanation: "èµ„äº§=è´Ÿå€º+æ‰€æœ‰è€…æƒç›Šæ˜¯åŸºæœ¬ï¼ˆé™æ€ï¼‰ä¼šè®¡ç­‰å¼ã€‚" },
                    { type: "choice", question: "æ”¶å…¥-è´¹ç”¨=åˆ©æ¶¦ æ˜¯ä»€ä¹ˆç­‰å¼ï¼Ÿ", options: ["é™æ€ä¼šè®¡ç­‰å¼", "åŠ¨æ€ä¼šè®¡ç­‰å¼", "åŸºæœ¬ä¼šè®¡ç­‰å¼", "ç»¼åˆä¼šè®¡ç­‰å¼"], answer: "B", explanation: "æ”¶å…¥-è´¹ç”¨=åˆ©æ¶¦æ˜¯åŠ¨æ€ä¼šè®¡ç­‰å¼ï¼Œåæ˜ ç»è¥æˆæœã€‚" },
                    { type: "calculate", question: "æŸå…¬å¸æœŸåˆï¼šèµ„äº§=500ä¸‡ï¼Œè´Ÿå€º=200ä¸‡ã€‚æœ¬æœŸå–å¾—æ”¶å…¥100ä¸‡ï¼Œå‘ç”Ÿè´¹ç”¨60ä¸‡ã€‚æœŸæœ«èµ„äº§æ˜¯å¤šå°‘ï¼Ÿï¼ˆè¯·è¾“å…¥æ•°å­—ï¼‰", answer: "540", explanation: "æœŸåˆæ‰€æœ‰è€…æƒç›Š=300ä¸‡ï¼›åˆ©æ¶¦=40ä¸‡ï¼›æœŸæœ«æ‰€æœ‰è€…æƒç›Š=340ä¸‡ï¼›æœŸæœ«èµ„äº§=200+340=540ä¸‡ã€‚" },
                    { type: "choice", question: "é”€å”®å•†å“æ”¶åˆ°ç°é‡‘ï¼Œå¯¹ä¼šè®¡ç­‰å¼çš„å½±å“æ˜¯ï¼Ÿ", options: ["èµ„äº§å¢åŠ ï¼Œè´Ÿå€ºå¢åŠ ", "èµ„äº§å¢åŠ ï¼Œæ‰€æœ‰è€…æƒç›Šå¢åŠ ", "èµ„äº§å†…éƒ¨å˜åŒ–", "æ‰€æœ‰è€…æƒç›Šå†…éƒ¨å˜åŒ–"], answer: "B", explanation: "é”€å”®å•†å“å¢åŠ æ”¶å…¥ï¼ˆæ‰€æœ‰è€…æƒç›Šï¼‰ï¼ŒåŒæ—¶ç°é‡‘å¢åŠ ï¼ˆèµ„äº§ï¼‰ã€‚" },
                    { type: "choice", question: "æ‰€æœ‰è€…æƒç›Šä¸å€ºæƒäººæƒç›Šçš„ä¸»è¦åŒºåˆ«æ˜¯ï¼Ÿ", options: ["æ‰€æœ‰è€…æƒç›Šéœ€è¦å¿è¿˜", "æ‰€æœ‰è€…äº«æœ‰åˆ©æ¶¦åˆ†é…æƒå’Œç»è¥ç®¡ç†æƒ", "ä¸¤è€…æ²¡æœ‰åŒºåˆ«", "æ¸…ç®—æ—¶æ‰€æœ‰è€…æƒç›Šä¼˜å…ˆæ±‚å¿"], answer: "B", explanation: "æ‰€æœ‰è€…æƒç›Šä¸éœ€è¦å¿è¿˜ï¼Œäº«æœ‰åˆ©æ¶¦åˆ†é…æƒï¼›å€ºæƒäººæƒç›Šéœ€è¦å¿è¿˜ï¼Œæœ‰ä¼˜å…ˆæ±‚å¿æƒã€‚" }
                ]
            },
            {
                id: 3, title: "æ¨¡å—3ï¼šä¼šè®¡å‡†åˆ™", description: "ä¼šè®¡å‡†åˆ™ä½“ç³»ã€GAAPã€IFRS", icon: "fa-balance-scale",
                questions: [
                    { type: "choice", question: "ä¸‹åˆ—å“ªé¡¹ä¸æ˜¯æˆ‘å›½ä¼šè®¡å‡†åˆ™ä½“ç³»çš„æ„æˆéƒ¨åˆ†ï¼Ÿ", options: ["åŸºæœ¬å‡†åˆ™", "å…·ä½“å‡†åˆ™", "åº”ç”¨æŒ‡å—", "ä¼šè®¡æ³•å¾‹"], answer: "D", explanation: "æˆ‘å›½ä¼šè®¡å‡†åˆ™ä½“ç³»åŒ…æ‹¬åŸºæœ¬å‡†åˆ™ã€å…·ä½“å‡†åˆ™ã€åº”ç”¨æŒ‡å—ã€‚" },
                    { type: "matching", question: "è¯·å°†ä¸‹åˆ—æœºæ„ä¸å¯¹åº”çš„å‡†åˆ™/ä½“ç³»è¿çº¿ï¼š", pairs: [{left: "FASB", right: "US GAAP"}, {left: "IASB", right: "IFRS"}, {left: "ä¸­å›½è´¢æ”¿éƒ¨", right: "ä¸­å›½ä¼ä¸šä¼šè®¡å‡†åˆ™(CAS)"}], answer: {"FASB": "US GAAP", "IASB": "IFRS", "ä¸­å›½è´¢æ”¿éƒ¨": "ä¸­å›½ä¼ä¸šä¼šè®¡å‡†åˆ™(CAS)"}, explanation: "FASBåˆ¶å®šUS GAAPï¼ŒIASBåˆ¶å®šIFRSï¼Œä¸­å›½è´¢æ”¿éƒ¨åˆ¶å®šCASã€‚" },
                    { type: "choice", question: "US GAAPä¸IFRSçš„ä¸»è¦åŒºåˆ«åœ¨äºï¼Ÿ", options: ["US GAAPæ˜¯è§„åˆ™å¯¼å‘ï¼ŒIFRSæ˜¯åŸåˆ™å¯¼å‘", "US GAAPæ˜¯åŸåˆ™å¯¼å‘ï¼ŒIFRSæ˜¯è§„åˆ™å¯¼å‘", "ä¸¤è€…æ²¡æœ‰åŒºåˆ«", "IFRSæ¯”US GAAPæ›´ä¸¥æ ¼"], answer: "A", explanation: "US GAAPä»¥è§„åˆ™ä¸ºä¸»ï¼Œè¦æ±‚æ›´ä¸¥æ ¼ï¼›IFRSä»¥åŸåˆ™ä¸ºä¸»ã€‚" }
                ]
            },
            {
                id: 4, title: "æ¨¡å—4ï¼šä¼šè®¡åŸºæœ¬å‰æï¼ˆå‡è®¾ï¼‰", description: "å››å¤§åŸºæœ¬å‡è®¾ã€æƒè´£å‘ç”Ÿåˆ¶", icon: "fa-landmark",
                questions: [
                    { type: "matching", question: "è¯·å°†ä¼šè®¡å‡è®¾ä¸å¯¹åº”çš„æè¿°è¿çº¿ï¼š", pairs: [{left: "ä¼šè®¡ä¸»ä½“", right: "ç•Œå®šä¼šè®¡æ ¸ç®—çš„ç©ºé—´èŒƒå›´"}, {left: "æŒç»­ç»è¥", right: "å‡å®šä¼ä¸šä¸ä¼šç ´äº§æ¸…ç®—"}, {left: "ä¼šè®¡åˆ†æœŸ", right: "å°†è¿ç»­ç»è¥åˆ’åˆ†ä¸ºæœŸé—´"}, {left: "è´§å¸è®¡é‡", right: "ä»¥è´§å¸ä¸ºä¸»è¦è®¡é‡å•ä½"}], answer: {"ä¼šè®¡ä¸»ä½“": "ç•Œå®šä¼šè®¡æ ¸ç®—çš„ç©ºé—´èŒƒå›´", "æŒç»­ç»è¥": "å‡å®šä¼ä¸šä¸ä¼šç ´äº§æ¸…ç®—", "ä¼šè®¡åˆ†æœŸ": "å°†è¿ç»­ç»è¥åˆ’åˆ†ä¸ºæœŸé—´", "è´§å¸è®¡é‡": "ä»¥è´§å¸ä¸ºä¸»è¦è®¡é‡å•ä½"}, explanation: "ä¼šè®¡ä¸»ä½“-ç©ºé—´ï¼›æŒç»­ç»è¥-æ—¶é—´ï¼›ä¼šè®¡åˆ†æœŸ-åˆ†æœŸï¼›è´§å¸è®¡é‡-è®¡é‡å•ä½ã€‚" },
                    { type: "choice", question: "7æœˆé”€å”®å•†å“ï¼Œ9æœˆæ”¶åˆ°è´§æ¬¾ã€‚æŒ‰æƒè´£å‘ç”Ÿåˆ¶ï¼Œæ”¶å…¥å½’å±äºå“ªä¸ªæœˆï¼Ÿ", options: ["7æœˆ", "8æœˆ", "9æœˆ", "å¹³å‡åˆ†æ‘Š"], answer: "A", explanation: "æƒè´£å‘ç”Ÿåˆ¶æŒ‰æƒåˆ©å½’å±ç¡®è®¤æ”¶å…¥ï¼Œ7æœˆå·²å®ç°æ”¶å…¥æƒåˆ©ã€‚" },
                    { type: "choice", question: "é¢„ä»˜å…¨å¹´æˆ¿ç§Ÿ12ä¸‡å…ƒï¼ŒæŒ‰æƒè´£å‘ç”Ÿåˆ¶ï¼Œ1æœˆä»½åº”ç¡®è®¤è´¹ç”¨å¤šå°‘ï¼Ÿï¼ˆè¯·è¾“å…¥æ•°å­—ï¼‰", options: ["12", "6", "1", "0"], answer: "1", explanation: "æƒè´£å‘ç”Ÿåˆ¶æŒ‰å—ç›ŠæœŸåˆ†æ‘Šï¼Œ12ä¸‡Ã·12æœˆ=1ä¸‡/æœˆã€‚" },
                    { type: "choice", question: "æ‰€æœ‰ä¼ä¸šéƒ½å¿…é¡»é‡‡ç”¨æƒè´£å‘ç”Ÿåˆ¶ã€‚", options: ["æ­£ç¡®", "é”™è¯¯"], answer: "B", explanation: "è¡Œæ”¿å•ä½ã€äº‹ä¸šå•ä½ç­‰å¯é‡‡ç”¨æ”¶ä»˜å®ç°åˆ¶ã€‚" }
                ]
            },
            {
                id: 5, title: "æ¨¡å—5ï¼šä¼šè®¡ä¿¡æ¯è´¨é‡è¦æ±‚", description: "å…«é¡¹è´¨é‡è¦æ±‚ã€æ¡ˆä¾‹åˆ†æ", icon: "fa-check-double",
                questions: [
                    { type: "scenario", question: "å”®åå›è´­åè®®ä¸­ï¼Œè™½æ³•å¾‹å½¢å¼å®Œæˆé”€å”®ï¼Œä½†å…¬å¸æ‰¿æ‹…ä¸»è¦é£é™©ï¼Œä¸ç¡®è®¤ä¸ºæ”¶å…¥ã€‚è¿™ä½“ç°äº†ä»€ä¹ˆï¼Ÿ", options: ["å¯é æ€§", "ç›¸å…³æ€§", "å®è´¨é‡äºå½¢å¼", "è°¨æ…æ€§"], answer: "C", explanation: "å®è´¨é‡äºå½¢å¼è¦æ±‚æŒ‰ç»æµå®è´¨è€Œéæ³•å¾‹å½¢å¼è¿›è¡Œä¼šè®¡å¤„ç†ã€‚" },
                    { type: "scenario", question: "è®¡æå­˜è´§è·Œä»·å‡†å¤‡ï¼Œä¸é«˜ä¼°èµ„äº§ã€‚è¿™ä½“ç°äº†ä»€ä¹ˆï¼Ÿ", options: ["å¯é æ€§", "è°¨æ…æ€§", "å¯ç†è§£æ€§", "åŠæ—¶æ€§"], answer: "B", explanation: "è°¨æ…æ€§è¦æ±‚ä¸åº”é«˜ä¼°èµ„äº§æˆ–æ”¶ç›Šï¼Œä¸åº”ä½ä¼°è´Ÿå€ºæˆ–è´¹ç”¨ã€‚" },
                    { type: "choice", question: "ä¸‹åˆ—å“ªé¡¹ä¸å±äºä¼šè®¡ä¿¡æ¯è´¨é‡çš„é¦–è¦è¦æ±‚ï¼Ÿ", options: ["å¯é æ€§", "ç›¸å…³æ€§", "å¯ç†è§£æ€§", "å®è´¨é‡äºå½¢å¼"], answer: "D", explanation: "å¯é æ€§ã€ç›¸å…³æ€§æ˜¯é¦–è¦è´¨é‡è¦æ±‚ã€‚" }
                ]
            },
            {
                id: 6, title: "æ¨¡å—6ï¼šç»¼åˆåº”ç”¨ï¼ˆä¸»è§‚é¢˜ï¼‰", description: "è´¢æŠ¥åˆ†æã€ç»¼åˆåº”ç”¨", icon: "fa-chart-line",
                questions: [
                    {
                        type: "essay",
                        question: "ç»¼åˆæŒ‘æˆ˜1ï¼šå›é¡¾\"ç¾å›¢2025Q2è´¢æŠ¥\"æ•°æ®ï¼ˆè¥æ”¶å¢é•¿11.7%ï¼Œä½†ç»è¥åˆ©æ¶¦æš´è·Œ98%ï¼‰ï¼Œå¹¶å¯¹æ¯”ä¼šè®¡çš„\"å†³ç­–æœ‰ç”¨è§‚\"å’Œ\"å—æ‰˜è´£ä»»è§‚\"ã€‚",
                        dataSummary: "è¥ä¸šæ”¶å…¥ï¼šåŒæ¯”å¢é•¿11.7%ï¼›é”€å”®æˆæœ¬ï¼šåŒæ¯”å¢é•¿28.3%ï¼›è¥é”€å¼€æ”¯ï¼šåŒæ¯”å¢é•¿52.7%ï¼›ç»è¥åˆ©æ¶¦ï¼šåŒæ¯”ä¸‹é™98%",
                        referenceAnswer: "å†³ç­–æœ‰ç”¨è§‚å¼ºè°ƒä¼šè®¡ä¿¡æ¯åº”å¸®åŠ©æŠ•èµ„è€…è¯„ä¼°ä¼ä¸šæœªæ¥ç°é‡‘æµå’Œç»è¥é£é™©ï¼Œè€Œè¯¥è´¢æŠ¥æ˜¾ç¤ºè™½ç„¶è¥æ”¶å¢é•¿ï¼Œä½†åˆ©æ¶¦ç»“æ„æ¶åŒ–ï¼Œæç¤ºæŠ•èµ„è€…å…³æ³¨å…¬å¸ç›ˆåˆ©æ¨¡å¼çš„å¯æŒç»­æ€§ã€‚å—æ‰˜è´£ä»»è§‚å¼ºè°ƒç®¡ç†å±‚åº”å¦‚å®æŠ¥å‘Šèµ„æºå—æ‰˜ç®¡ç†è´£ä»»ï¼Œè´¢æŠ¥æ•°æ®æ­ç¤ºäº†å…¬å¸åœ¨æ‰©å¼ ç­–ç•¥ä¸‹ç‰ºç‰²çŸ­æœŸåˆ©æ¶¦æ¢å–å¸‚åœºä»½é¢çš„å†³ç­–ï¼Œç®¡ç†å±‚åº”è§£é‡Šè¿™ç§æƒè¡¡çš„åˆç†æ€§å’Œæœªæ¥å›æŠ¥é¢„æœŸã€‚"
                    },
                    {
                        type: "essay",
                        question: "ç»¼åˆæŒ‘æˆ˜2ï¼šä½œä¸ºè°ƒæŸ¥å‘˜ï¼ŒåŸºäºæ­¤è´¢æŠ¥ï¼Œä½ ä¼šé‡ç‚¹å…³æ³¨å“ªäº›éè´¢åŠ¡ä¿¡æ¯æˆ–ä¸‹ä¸€æ­¥è°ƒæŸ¥æ–¹å‘ï¼Ÿ",
                        referenceAnswer: "æˆ‘ä¼šé‡ç‚¹å…³æ³¨ï¼šâ‘ å¯¼è‡´é”€å”®æˆæœ¬ä¸è¥é”€å¼€æ”¯æ¿€å¢çš„å…·ä½“åŸå› ï¼ˆå¦‚æ–°ä¸šåŠ¡æŠ•å…¥ã€ä»·æ ¼æˆ˜ã€ç›‘ç®¡å˜åŒ–ï¼‰ï¼›â‘¡è¿™ç§åˆ©æ¶¦ç»“æ„å˜åŒ–æ˜¯çŸ­æœŸç­–ç•¥è¿˜æ˜¯é•¿æœŸè¶‹åŠ¿ï¼›â‘¢å…¬å¸ç®¡ç†å±‚å¯¹ä¸Šè¿°æƒ…å†µçš„è§£é‡ŠåŠæœªæ¥è®¡åˆ’ã€‚è¿™éœ€è¦æŸ¥é˜…è´¢æŠ¥é™„æ³¨ã€ç®¡ç†å±‚è®¨è®ºä¸åˆ†æä»¥åŠè¡Œä¸šæ–°é—»ã€‚"
                    }
                ]
            }
        ];

        const TOTAL_QUESTIONS = modules.reduce((sum, m) => sum + m.questions.length, 0);
        const POINTS_PER_QUESTION = 100 / TOTAL_QUESTIONS;

        const gameState = { playerName: "", currentModule: null, currentQuestionIndex: 0, moduleProgress: {}, moduleScores: {}, isViewMode: false };
        const LEADERBOARD_KEY = 'accounting_practice_leaderboard_v3';

        function getLeaderboard() {
            const data = localStorage.getItem(LEADERBOARD_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveToLeaderboard() {
            const leaderboard = getLeaderboard();
            const existingIndex = leaderboard.findIndex(e => e.name === gameState.playerName);

            let totalCorrect = 0, totalAnswered = 0, completedModules = 0;
            Object.keys(gameState.moduleProgress).forEach(moduleId => {
                const progress = gameState.moduleProgress[moduleId];
                Object.values(progress.answers).forEach(ans => {
                    totalAnswered++;
                    if (ans.correct) totalCorrect++;
                });
                if (progress.completed) completedModules++;
            });

            // æ”¶é›†ä¸»è§‚é¢˜ç­”æ¡ˆ
            const essayAnswers = {};
            if (gameState.moduleProgress[6] && gameState.moduleProgress[6].answers) {
                Object.keys(gameState.moduleProgress[6].answers).forEach(qIndex => {
                    const ans = gameState.moduleProgress[6].answers[qIndex];
                    if (ans && ans.userAnswer) {
                        essayAnswers[`Q${parseInt(qIndex) + 1}`] = ans.userAnswer;
                    }
                });
            }

            const entry = {
                name: gameState.playerName,
                totalScore: Math.round(totalCorrect * POINTS_PER_QUESTION),
                correctCount: totalCorrect,
                totalAnswered: totalAnswered,
                completedModules: completedModules,
                moduleScores: {...gameState.moduleScores},
                moduleProgress: JSON.parse(JSON.stringify(gameState.moduleProgress)),
                essayAnswers: essayAnswers,
                timestamp: new Date().getTime(),
                date: new Date().toLocaleString('zh-CN')
            };

            if (existingIndex >= 0) {
                leaderboard[existingIndex] = entry;
            } else {
                leaderboard.push(entry);
            }

            leaderboard.sort((a, b) => {
                if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
                if (b.correctCount !== a.correctCount) return b.correctCount - a.correctCount;
                return a.timestamp - b.timestamp;
            });

            localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard.slice(0, 100)));
            updateRankDisplay();
            updateGameInfo();
        }

        function getRank() {
            const leaderboard = getLeaderboard();
            const index = leaderboard.findIndex(e => e.name === gameState.playerName);
            return index >= 0 ? index + 1 : '-';
        }

        function updateRankDisplay() {
            document.getElementById('current-rank').textContent = getRank();
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function updateGameInfo() {
            let totalCorrect = 0, totalAnswered = 0;
            Object.keys(gameState.moduleProgress).forEach(moduleId => {
                const progress = gameState.moduleProgress[moduleId];
                Object.values(progress.answers).forEach(ans => {
                    totalAnswered++;
                    if (ans.correct) totalCorrect++;
                });
            });
            const totalScore = Math.round(totalCorrect * POINTS_PER_QUESTION);
            document.getElementById('player-name-display').textContent = gameState.playerName;
            document.getElementById('total-score').textContent = totalScore;
            document.getElementById('correct-count').textContent = totalCorrect;
            document.getElementById('total-questions-count').textContent = TOTAL_QUESTIONS;
            document.getElementById('current-rank').textContent = getRank();
        }

        function updateModuleCards() {
            const grid = document.getElementById('module-grid');
            grid.innerHTML = '';
            modules.forEach(module => {
                const progress = gameState.moduleProgress[module.id] || {answers: {}, completed: false};
                const answeredCount = Object.keys(progress.answers).length;
                const totalCount = module.questions.length;
                const isCompleted = progress.completed;
                const isInProgress = answeredCount > 0 && !isCompleted;

                let correctCount = 0;
                Object.values(progress.answers).forEach(ans => { if (ans.correct) correctCount++; });

                let statusClass = 'status-pending', statusText = 'æœªå¼€å§‹', cardClass = '';
                if (isCompleted) { statusClass = 'status-completed'; statusText = 'å·²å®Œæˆ'; cardClass = 'completed'; }
                else if (isInProgress) { statusClass = 'status-progress'; statusText = 'è¿›è¡Œä¸­'; cardClass = 'in-progress'; }

                const card = document.createElement('div');
                card.className = `module-card ${cardClass}`;
                card.innerHTML = `
                    <div class="module-icon"><i class="fas ${module.icon}"></i></div>
                    <div class="module-title">${module.title}</div>
                    <div class="module-desc">${module.description}</div>
                    <div class="module-progress">
                        <span>${correctCount}/${totalCount} æ­£ç¡®</span>
                        <div class="module-progress-bar">
                            <div class="module-progress-fill" style="width: ${answeredCount > 0 ? (answeredCount / totalCount * 100) : 0}%"></div>
                        </div>
                        <span class="module-status ${statusClass}">${statusText}</span>
                    </div>
                `;
                card.onclick = () => startModule(module.id);
                grid.appendChild(card);
            });
        }

        function displayLeaderboard(tab = 'total') {
            const leaderboard = getLeaderboard();
            const tbody = document.getElementById('leaderboard-body');

            if (leaderboard.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 30px; color: #999;">æš‚æ— æ’åæ•°æ®</td></tr>';
                return;
            }

            // æ ¹æ®æ ‡ç­¾è·å–å¯¹åº”åˆ†æ•°çš„å‡½æ•°
            const getScoreForTab = (entry, tab) => {
                if (tab === 'total') return entry.totalScore;
                const moduleNum = parseInt(tab.replace('module', ''));
                return entry.moduleScores[moduleNum] || 0;
            };

            // æ ¹æ®æ ‡ç­¾è·å–å¯¹åº”ç­”å¯¹é¢˜æ•°çš„å‡½æ•°
            const getCorrectForTab = (entry, tab) => {
                if (tab === 'total') return entry.correctCount;
                const moduleNum = parseInt(tab.replace('module', ''));
                if (!entry.moduleProgress || !entry.moduleProgress[moduleNum]) return 0;
                let correct = 0;
                Object.values(entry.moduleProgress[moduleNum].answers || {}).forEach(ans => {
                    if (ans.correct) correct++;
                });
                return correct;
            };

            // æ ¹æ®æ ‡ç­¾è·å–å¯¹åº”æ€»é¢˜æ•°çš„å‡½æ•°
            const getTotalForTab = (entry, tab) => {
                if (tab === 'total') return entry.totalAnswered;
                const moduleNum = parseInt(tab.replace('module', ''));
                if (!entry.moduleProgress || !entry.moduleProgress[moduleNum]) return 0;
                return Object.keys(entry.moduleProgress[moduleNum].answers || {}).length;
            };

            // æ ¹æ®æ ‡ç­¾æ’åº
            const sortedLeaderboard = [...leaderboard].sort((a, b) => {
                const scoreA = getScoreForTab(a, tab);
                const scoreB = getScoreForTab(b, tab);
                if (scoreB !== scoreA) return scoreB - scoreA;
                const correctA = getCorrectForTab(a, tab);
                const correctB = getCorrectForTab(b, tab);
                if (correctB !== correctA) return correctB - correctA;
                return a.timestamp - b.timestamp;
            });

            // æ›´æ–°è¡¨å¤´
            const scoreHeader = tab === 'total' ? 'ç´¯è®¡å¾—åˆ†' : `æ¨¡å—${tab.replace('module', '')}å¾—åˆ†`;
            document.querySelector('.leaderboard-table th:nth-child(3)').textContent = scoreHeader;

            let html = '';
            sortedLeaderboard.forEach((entry, index) => {
                const rank = index + 1;
                const isMyRank = entry.name === gameState.playerName;
                const rowClass = isMyRank ? 'my-rank' : (rank <= 3 ? `rank-${rank}` : '');

                const score = getScoreForTab(entry, tab);
                const correct = getCorrectForTab(entry, tab);
                const total = getTotalForTab(entry, tab);

                html += `<tr class="${rowClass}">`;
                html += `<td>${rank}${rank <= 3 ? ' ğŸ†' : ''}</td>`;
                html += `<td>${entry.name}</td>`;
                html += `<td>${score}</td>`;
                html += `<td>${tab === 'total' ? `${correct}/${total}` : (total > 0 ? `${correct}/${total}` : '-')}</td>`;
                html += `<td>${entry.completedModules}/6</td>`;
                html += `<td>${entry.date.split(' ')[1]}</td>`;
                html += '</tr>';
            });

            tbody.innerHTML = html;
        }

        function startModule(moduleId) {
            gameState.currentModule = moduleId;
            gameState.isViewMode = false;
            if (!gameState.moduleProgress[moduleId]) {
                gameState.moduleProgress[moduleId] = { answers: {}, completed: false };
            }

            const progress = gameState.moduleProgress[moduleId];
            const module = modules.find(m => m.id === moduleId);

            if (progress.completed) {
                if (confirm('è¯¥æ¨¡å—å·²å®Œæˆï¼Œæ˜¯å¦é‡æ–°å¼€å§‹ï¼Ÿé‡æ–°å¼€å§‹å°†æ¸…ç©ºè¯¥æ¨¡å—çš„æˆç»©ã€‚')) {
                    gameState.moduleProgress[moduleId] = { answers: {}, completed: false };
                    delete gameState.moduleScores[moduleId];
                    saveToLeaderboard();
                } else {
                    return;
                }
            }

            gameState.currentQuestionIndex = 0;
            for (let i = 0; i < module.questions.length; i++) {
                if (!progress.answers[i]) {
                    gameState.currentQuestionIndex = i;
                    break;
                }
            }

            showQuestion();
            showScreen('screen-question');
        }

        function showQuestion() {
            const module = modules.find(m => m.id === gameState.currentModule);
            const question = module.questions[gameState.currentQuestionIndex];
            const progress = gameState.moduleProgress[gameState.currentModule];
            const answeredCount = Object.keys(progress.answers).length;
            let correctCount = 0;
            Object.values(progress.answers).forEach(ans => { if (ans.correct) correctCount++; });

            document.getElementById('question-progress').textContent = `é¢˜ç›® ${gameState.currentQuestionIndex + 1}/${module.questions.length}`;
            document.getElementById('module-progress').textContent = `å·²å®Œæˆ: ${correctCount}/${answeredCount} æ­£ç¡®`;
            document.getElementById('question-progress-bar').style.width = `${((gameState.currentQuestionIndex + 1) / module.questions.length) * 100}%`;

            document.getElementById('feedback').classList.remove('show');
            document.getElementById('next-question').style.display = 'none';
            document.getElementById('prev-question').style.display = 'none';
            document.getElementById('resume-question').style.display = 'none';
            document.getElementById('submit-answer').style.display = 'flex';

            const container = document.getElementById('question-container');
            container.innerHTML = '';
            const existingAnswer = progress.answers[gameState.currentQuestionIndex];

            if (question.type === 'choice' || question.type === 'scenario') {
                container.innerHTML = `
                    <div class="question">
                        <div class="question-title">${question.question}</div>
                        <div class="options">
                            ${question.options.map((opt, i) => `
                                <div class="option ${existingAnswer ? 'answered' : ''}" data-index="${i}">
                                    <span class="option-prefix">${String.fromCharCode(65 + i)}</span>
                                    <span>${opt}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                if (existingAnswer) {
                    document.querySelectorAll('.option').forEach(opt => {
                        const optIndex = String.fromCharCode(65 + parseInt(opt.dataset.index));
                        if (optIndex === question.answer) { opt.classList.add('correct'); }
                        else if (optIndex === existingAnswer.userAnswer && !existingAnswer.correct) { opt.classList.add('incorrect'); }
                    });
                    showFeedback(existingAnswer.correct, question.explanation);
                    document.getElementById('submit-answer').style.display = 'none';

                    // å·²ç­”é¢˜ç›®çš„å¯¼èˆªé€»è¾‘
                    if (gameState.currentQuestionIndex < module.questions.length - 1) {
                        document.getElementById('next-question').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>';
                        document.getElementById('next-question').style.display = 'flex';
                        document.getElementById('next-question').onclick = () => goToQuestion(gameState.currentQuestionIndex + 1);
                    } else {
                        showNextModuleButton();
                    }

                    // å¦‚æœæ˜¯å·²ç­”é¢˜ç›®ï¼Œå¯ç”¨ä¸Šä¸€é¢˜å¯¼èˆª
                    gameState.isViewMode = true;
                    if (gameState.currentQuestionIndex > 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                } else {
                    // æœªç­”é¢˜ç›®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º"ä¸Šä¸€é¢˜"æŒ‰é’®
                    if (gameState.currentQuestionIndex > 0 && getLastAnsweredIndex() >= 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                    container.querySelectorAll('.option').forEach(opt => {
                        opt.addEventListener('click', function() {
                            if (this.classList.contains('answered')) return;
                            container.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                            this.classList.add('selected');
                        });
                    });
                }
            } else if (question.type === 'matching') {
                const options = Object.values(question.answer);
                container.innerHTML = `
                    <div class="question">
                        <div class="question-title">${question.question}</div>
                        <div class="matching-container">
                            ${question.pairs.map((pair, i) => `
                                <div class="matching-row">
                                    <div class="matching-left">${pair.left}</div>
                                    <div class="matching-arrow">â†’</div>
                                    <select class="matching-select" data-left="${pair.left}" ${existingAnswer ? 'disabled' : ''}>
                                        <option value="">è¯·é€‰æ‹©</option>
                                        ${options.map(opt => `<option value="${opt}" ${existingAnswer && existingAnswer.userAnswer[pair.left] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                if (existingAnswer) {
                    container.querySelectorAll('.matching-select').forEach(select => {
                        if (select.value === question.answer[select.dataset.left]) {
                            select.style.borderColor = '#4caf50';
                            select.style.backgroundColor = '#e8f5e9';
                        } else if (select.value) {
                            select.style.borderColor = '#f44336';
                            select.style.backgroundColor = '#ffebee';
                        }
                    });
                    showFeedback(existingAnswer.correct, question.explanation);
                    document.getElementById('submit-answer').style.display = 'none';
                    gameState.isViewMode = true;
                    if (gameState.currentQuestionIndex < module.questions.length - 1) {
                        document.getElementById('next-question').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>';
                        document.getElementById('next-question').style.display = 'flex';
                        document.getElementById('next-question').onclick = () => goToQuestion(gameState.currentQuestionIndex + 1);
                    } else { showNextModuleButton(); }
                    if (gameState.currentQuestionIndex > 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                } else {
                    // æœªç­”é¢˜ç›®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º"ä¸Šä¸€é¢˜"æŒ‰é’®
                    if (gameState.currentQuestionIndex > 0 && getLastAnsweredIndex() >= 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                }
            } else if (question.type === 'classify') {
                container.innerHTML = `
                    <div class="question">
                        <div class="question-title">${question.question}</div>
                        <div class="matching-container">
                            ${question.items.map(item => `
                                <div class="matching-row">
                                    <div class="matching-left">${item}</div>
                                    <div class="matching-arrow">â†’</div>
                                    <select class="matching-select" data-item="${item}" ${existingAnswer ? 'disabled' : ''}>
                                        <option value="">è¯·é€‰æ‹©ç±»åˆ«</option>
                                        ${question.categories.map(cat => `<option value="${cat}" ${existingAnswer && existingAnswer.userAnswer[item] === cat ? 'selected' : ''}>${cat}</option>`).join('')}
                                    </select>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                if (existingAnswer) {
                    container.querySelectorAll('.matching-select').forEach(select => {
                        if (select.value === question.answer[select.dataset.item]) {
                            select.style.borderColor = '#4caf50';
                            select.style.backgroundColor = '#e8f5e9';
                        } else if (select.value) {
                            select.style.borderColor = '#f44336';
                            select.style.backgroundColor = '#ffebee';
                        }
                    });
                    showFeedback(existingAnswer.correct, question.explanation);
                    document.getElementById('submit-answer').style.display = 'none';
                    gameState.isViewMode = true;
                    if (gameState.currentQuestionIndex < module.questions.length - 1) {
                        document.getElementById('next-question').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>';
                        document.getElementById('next-question').style.display = 'flex';
                        document.getElementById('next-question').onclick = () => goToQuestion(gameState.currentQuestionIndex + 1);
                    } else { showNextModuleButton(); }
                    if (gameState.currentQuestionIndex > 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                } else {
                    // æœªç­”é¢˜ç›®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º"ä¸Šä¸€é¢˜"æŒ‰é’®
                    if (gameState.currentQuestionIndex > 0 && getLastAnsweredIndex() >= 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                }
            } else if (question.type === 'calculate') {
                container.innerHTML = `
                    <div class="question">
                        <div class="question-title">${question.question}</div>
                        <div style="text-align: center; padding: 20px;">
                            <input type="text" class="fill-blank" id="calculate-answer" placeholder="è¾“å…¥ç­”æ¡ˆ" style="width: 200px; font-size: 1.2rem;" ${existingAnswer ? 'disabled' : ''} value="${existingAnswer ? existingAnswer.userAnswer : ''}">
                        </div>
                    </div>
                `;
                if (existingAnswer) {
                    const input = document.getElementById('calculate-answer');
                    if (existingAnswer.correct) {
                        input.style.borderColor = '#4caf50';
                        input.style.backgroundColor = '#e8f5e9';
                    } else {
                        input.style.borderColor = '#f44336';
                        input.style.backgroundColor = '#ffebee';
                    }
                    showFeedback(existingAnswer.correct, question.explanation);
                    document.getElementById('submit-answer').style.display = 'none';
                    gameState.isViewMode = true;
                    if (gameState.currentQuestionIndex < module.questions.length - 1) {
                        document.getElementById('next-question').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>';
                        document.getElementById('next-question').style.display = 'flex';
                        document.getElementById('next-question').onclick = () => goToQuestion(gameState.currentQuestionIndex + 1);
                    } else { showNextModuleButton(); }
                    if (gameState.currentQuestionIndex > 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                } else {
                    // æœªç­”é¢˜ç›®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º"ä¸Šä¸€é¢˜"æŒ‰é’®
                    if (gameState.currentQuestionIndex > 0 && getLastAnsweredIndex() >= 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                }
            } else if (question.type === 'essay') {
                let dataSummaryHtml = '';
                if (question.dataSummary) {
                    dataSummaryHtml = `
                        <div class="data-summary">
                            <h4><i class="fas fa-chart-bar"></i> è´¢æŠ¥æ•°æ®æ‘˜è¦</h4>
                            <ul>${question.dataSummary.split('ï¼›').map(item => `<li>${item}</li>`).join('')}</ul>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="question">
                        <div class="question-title">${question.question}</div>
                        ${dataSummaryHtml}
                        <textarea class="essay-answer" id="essay-answer" rows="6" placeholder="è¯·åœ¨æ­¤è¾“å…¥ä½ çš„åˆ†æ..." ${existingAnswer ? 'disabled' : ''}>${existingAnswer ? existingAnswer.userAnswer : ''}</textarea>
                        <div class="reference-answer" style="display: none;" id="reference-answer">
                            <h4><i class="fas fa-lightbulb"></i> å‚è€ƒç­”æ¡ˆ</h4>
                            <p>${question.referenceAnswer}</p>
                        </div>
                    </div>
                `;

                if (existingAnswer) {
                    document.getElementById('reference-answer').style.display = 'block';
                    document.getElementById('submit-answer').style.display = 'none';
                    gameState.isViewMode = true;
                    if (gameState.currentQuestionIndex < module.questions.length - 1) {
                        document.getElementById('next-question').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>';
                        document.getElementById('next-question').style.display = 'flex';
                        document.getElementById('next-question').onclick = () => goToQuestion(gameState.currentQuestionIndex + 1);
                    } else {
                        document.getElementById('next-question').innerHTML = 'æŸ¥çœ‹æ¨¡å—æˆç»© <i class="fas fa-chart-bar"></i>';
                        document.getElementById('next-question').style.display = 'flex';
                        document.getElementById('next-question').onclick = showModuleComplete;
                    }
                    if (gameState.currentQuestionIndex > 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                } else {
                    // æœªç­”é¢˜ç›®ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ˜¾ç¤º"ä¸Šä¸€é¢˜"æŒ‰é’®
                    if (gameState.currentQuestionIndex > 0 && getLastAnsweredIndex() >= 0) {
                        document.getElementById('prev-question').style.display = 'flex';
                    }
                }
            }
        }

        function showNextModuleButton() {
            const btn = document.getElementById('next-question');
            btn.innerHTML = 'æŸ¥çœ‹æ¨¡å—æˆç»© <i class="fas fa-chart-bar"></i>';
            btn.style.display = 'flex';
            btn.onclick = showModuleComplete;
        }

        function showFeedback(isCorrect, explanation) {
            const feedback = document.getElementById('feedback');
            const feedbackText = document.getElementById('feedback-text');
            feedbackText.innerHTML = `<p style="margin-bottom: 10px;"><strong>${isCorrect ? 'âœ“ æ­£ç¡®ï¼' : 'âœ— é”™è¯¯'}</strong></p><p>${explanation}</p>`;
            feedback.classList.add('show');
        }

        function submitAnswer() {
            const module = modules.find(m => m.id === gameState.currentModule);
            const question = module.questions[gameState.currentQuestionIndex];
            let userAnswer = null;
            let isCorrect = false;

            if (question.type === 'choice' || question.type === 'scenario') {
                const selected = document.querySelector('.option.selected');
                if (!selected) { alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç­”æ¡ˆï¼'); return; }
                userAnswer = String.fromCharCode(65 + parseInt(selected.dataset.index));
                isCorrect = userAnswer === question.answer;
                document.querySelectorAll('.option').forEach(opt => {
                    opt.classList.add('answered');
                    const optIndex = String.fromCharCode(65 + parseInt(opt.dataset.index));
                    if (optIndex === question.answer) { opt.classList.add('correct'); }
                    else if (optIndex === userAnswer && !isCorrect) { opt.classList.add('incorrect'); }
                });
            } else if (question.type === 'matching') {
                const selects = document.querySelectorAll('.matching-select');
                userAnswer = {};
                let allAnswered = true;
                selects.forEach(select => {
                    if (!select.value) { allAnswered = false; }
                    userAnswer[select.dataset.left] = select.value;
                });
                if (!allAnswered) { alert('è¯·å®Œæˆæ‰€æœ‰è¿çº¿ï¼'); return; }
                isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.answer);
                selects.forEach(select => {
                    select.disabled = true;
                    if (select.value === question.answer[select.dataset.left]) {
                        select.style.borderColor = '#4caf50';
                        select.style.backgroundColor = '#e8f5e9';
                    } else {
                        select.style.borderColor = '#f44336';
                        select.style.backgroundColor = '#ffebee';
                    }
                });
            } else if (question.type === 'classify') {
                const selects = document.querySelectorAll('.matching-select');
                userAnswer = {};
                let allAnswered = true;
                selects.forEach(select => {
                    if (!select.value) { allAnswered = false; }
                    userAnswer[select.dataset.item] = select.value;
                });
                if (!allAnswered) { alert('è¯·å®Œæˆæ‰€æœ‰å½’ç±»ï¼'); return; }
                isCorrect = JSON.stringify(userAnswer) === JSON.stringify(question.answer);
                selects.forEach(select => {
                    select.disabled = true;
                    if (select.value === question.answer[select.dataset.item]) {
                        select.style.borderColor = '#4caf50';
                        select.style.backgroundColor = '#e8f5e9';
                    } else {
                        select.style.borderColor = '#f44336';
                        select.style.backgroundColor = '#ffebee';
                    }
                });
            } else if (question.type === 'calculate') {
                userAnswer = document.getElementById('calculate-answer').value.trim();
                if (!userAnswer) { alert('è¯·è¾“å…¥ç­”æ¡ˆï¼'); return; }
                isCorrect = userAnswer === question.answer;
                const input = document.getElementById('calculate-answer');
                input.disabled = true;
                if (isCorrect) {
                    input.style.borderColor = '#4caf50';
                    input.style.backgroundColor = '#e8f5e9';
                } else {
                    input.style.borderColor = '#f44336';
                    input.style.backgroundColor = '#ffebee';
                }
            } else if (question.type === 'essay') {
                userAnswer = document.getElementById('essay-answer').value.trim();
                if (!userAnswer) { alert('è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆï¼'); return; }
                // ä¸»è§‚é¢˜ä¸ç®—å¯¹é”™ï¼Œåªè¦å›ç­”å°±ç®—æ­£ç¡®
                isCorrect = true;
                document.getElementById('essay-answer').disabled = true;
                document.getElementById('reference-answer').style.display = 'block';
            }

            const progress = gameState.moduleProgress[gameState.currentModule];
            progress.answers[gameState.currentQuestionIndex] = { userAnswer, correct: isCorrect };

            showFeedback(isCorrect, question.type === 'essay' ? 'ç­”æ¡ˆå·²ä¿å­˜ï¼' : question.explanation);
            document.getElementById('submit-answer').style.display = 'none';

            // ç­”é¢˜åæ˜¾ç¤ºä¸Šä¸€é¢˜æŒ‰é’®ï¼ˆå¦‚æœæœ‰å·²ç­”é¢˜ç›®ï¼‰
            if (gameState.currentQuestionIndex > 0) {
                document.getElementById('prev-question').style.display = 'flex';
            }

            if (gameState.currentQuestionIndex < module.questions.length - 1) {
                document.getElementById('next-question').innerHTML = 'ä¸‹ä¸€é¢˜ <i class="fas fa-arrow-right"></i>';
                document.getElementById('next-question').style.display = 'flex';
                document.getElementById('next-question').onclick = nextQuestion;
            } else {
                showNextModuleButton();
            }

            saveToLeaderboard();
        }

        function nextQuestion() {
            gameState.isViewMode = false; // é‡ç½®æµè§ˆæ¨¡å¼
            const module = modules.find(m => m.id === gameState.currentModule);
            for (let i = gameState.currentQuestionIndex + 1; i < module.questions.length; i++) {
                if (!gameState.moduleProgress[gameState.currentModule].answers[i]) {
                    gameState.currentQuestionIndex = i;
                    showQuestion();
                    return;
                }
            }
            showModuleComplete();
        }

        function showModuleComplete() {
            const progress = gameState.moduleProgress[gameState.currentModule];
            const module = modules.find(m => m.id === gameState.currentModule);

            let correctCount = 0;
            Object.values(progress.answers).forEach(ans => { if (ans.correct) correctCount++; });

            // è®¡ç®—æ¨¡å—å¾—åˆ†ï¼ˆæŒ‰æ­£ç¡®ç‡ï¼‰
            const score = Math.round((correctCount / module.questions.length) * 100);

            progress.completed = true;
            gameState.moduleScores[gameState.currentModule] = score;

            document.getElementById('module-score').textContent = score;
            document.getElementById('module-correct').textContent = `${correctCount}/${module.questions.length}`;
            document.getElementById('module-points').textContent = Math.round(correctCount * POINTS_PER_QUESTION).toFixed(1);

            showScreen('screen-module-complete');
            saveToLeaderboard();
        }

        // è·å–å½“å‰æ¨¡å—çš„æœ€åç­”é¢˜ç´¢å¼•
        function getLastAnsweredIndex() {
            const progress = gameState.moduleProgress[gameState.currentModule];
            if (!progress || !progress.answers) return -1;

            let lastIndex = -1;
            Object.keys(progress.answers).forEach(index => {
                const numIndex = parseInt(index);
                if (numIndex > lastIndex) {
                    lastIndex = numIndex;
                }
            });
            return lastIndex;
        }

        // è·³è½¬åˆ°æŒ‡å®šé¢˜ç›®ï¼ˆç”¨äºå¯¼èˆªï¼‰
        function goToQuestion(questionIndex) {
            gameState.currentQuestionIndex = questionIndex;
            const progress = gameState.moduleProgress[gameState.currentModule];

            // åˆ¤æ–­æ˜¯å¦è¿›å…¥æµè§ˆæ¨¡å¼
            if (progress.answers[questionIndex]) {
                gameState.isViewMode = true;
            } else {
                gameState.isViewMode = false;
            }

            showQuestion();
        }

        // ä¸Šä¸€é¢˜
        function goToPrevQuestion() {
            if (gameState.currentQuestionIndex > 0) {
                goToQuestion(gameState.currentQuestionIndex - 1);
            }
        }

        // ç»§ç»­ç­”é¢˜ï¼ˆè·³è½¬åˆ°å½“å‰æœªç­”é¢˜ç›®ï¼‰
        function resumeQuestion() {
            const progress = gameState.moduleProgress[gameState.currentModule];
            const module = modules.find(m => m.id === gameState.currentModule);

            gameState.isViewMode = false;

            // æ‰¾åˆ°ç¬¬ä¸€é¢˜æœªç­”çš„é¢˜ç›®
            for (let i = 0; i < module.questions.length; i++) {
                if (!progress.answers[i]) {
                    gameState.currentQuestionIndex = i;
                    showQuestion();
                    return;
                }
            }

            // å¦‚æœéƒ½ç­”å®Œäº†ï¼Œæ˜¾ç¤ºå®Œæˆé¡µé¢
            showModuleComplete();
        }

        function exportLeaderboard() {
            const leaderboard = getLeaderboard();
            if (leaderboard.length === 0) { alert('æš‚æ— æ•°æ®å¯å¯¼å‡º'); return; }

            let csv = 'æ’å,å§“å,ç´¯è®¡å¾—åˆ†,ç­”å¯¹é¢˜æ•°,ç­”é¢˜æ€»æ•°,å®Œæˆæ¨¡å—æ•°,æ¨¡å—1,æ¨¡å—2,æ¨¡å—3,æ¨¡å—4,æ¨¡å—5,æ¨¡å—6,ä¸»è§‚é¢˜Q1,ä¸»è§‚é¢˜Q2,æ—¶é—´\n';

            leaderboard.forEach((entry, index) => {
                csv += `${index + 1},`;
                csv += `${entry.name},`;
                csv += `${entry.totalScore},`;
                csv += `${entry.correctCount},`;
                csv += `${entry.totalAnswered},`;
                csv += `${entry.completedModules},`;
                for (let i = 1; i <= 6; i++) {
                    csv += `${entry.moduleScores[i] || 0},`;
                }
                csv += `"${(entry.essayAnswers?.Q1 || '').replace(/"/g, '""')}",`;
                csv += `"${(entry.essayAnswers?.Q2 || '').replace(/"/g, '""')}",`;
                csv += `${entry.date}\n`;
            });

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ä¼šè®¡ç»ƒä¹ æ’è¡Œæ¦œ_${new Date().toLocaleDateString('zh-CN')}.csv`;
            link.click();
        }

        function exportEssayAnswers() {
            const leaderboard = getLeaderboard();
            if (leaderboard.length === 0) { alert('æš‚æ— ä¸»è§‚é¢˜ç­”æ¡ˆå¯å¯¼å‡º'); return; }

            let hasAnswers = false;
            leaderboard.forEach(entry => {
                if (entry.essayAnswers && Object.keys(entry.essayAnswers).length > 0) {
                    hasAnswers = true;
                }
            });

            if (!hasAnswers) {
                alert('ç›®å‰è¿˜æ²¡æœ‰åŒå­¦å®Œæˆä¸»è§‚é¢˜');
                return;
            }

            let content = 'ä¼šè®¡å­¦åŸç†Â·ç¬¬ä¸€ç«  ä¸»è§‚é¢˜ç­”æ¡ˆæ±‡æ€»\n';
            content += '====================================\n\n';
            content += `å¯¼å‡ºæ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\n\n`;

            leaderboard.forEach((entry, index) => {
                if (entry.essayAnswers && Object.keys(entry.essayAnswers).length > 0) {
                    content += `ã€${index + 1}. ${entry.name}ã€‘\n`;
                    content += `ç´¯è®¡å¾—åˆ†ï¼š${entry.totalScore}\n`;
                    content += `------------------------------------\n`;
                    if (entry.essayAnswers.Q1) {
                        content += `é¢˜ç›®1ç­”æ¡ˆï¼š\n${entry.essayAnswers.Q1}\n\n`;
                    }
                    if (entry.essayAnswers.Q2) {
                        content += `é¢˜ç›®2ç­”æ¡ˆï¼š\n${entry.essayAnswers.Q2}\n\n`;
                    }
                    content += '\n';
                }
            });

            const blob = new Blob(['\ufeff' + content], { type: 'text/plain;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ä¸»è§‚é¢˜ç­”æ¡ˆæ±‡æ€»_${new Date().toLocaleDateString('zh-CN')}.txt`;
            link.click();
        }

        document.getElementById('start-game').addEventListener('click', function() {
            const name = document.getElementById('player-name').value.trim();
            if (!name) { alert('è¯·è¾“å…¥ä½ çš„å§“åï¼'); return; }
            gameState.playerName = name;
            loadSavedProgress();
            document.getElementById('game-info').style.display = 'flex';
            updateGameInfo();
            updateModuleCards();
            showScreen('screen-modules');
        });

        function loadSavedProgress() {
            const leaderboard = getLeaderboard();
            const savedEntry = leaderboard.find(e => e.name === gameState.playerName);
            if (savedEntry && savedEntry.moduleProgress) {
                Object.keys(savedEntry.moduleProgress).forEach(moduleId => {
                    const moduleIdNum = parseInt(moduleId);
                    gameState.moduleProgress[moduleIdNum] = savedEntry.moduleProgress[moduleId];
                    if (savedEntry.moduleScores[moduleIdNum]) {
                        gameState.moduleScores[moduleIdNum] = savedEntry.moduleScores[moduleIdNum];
                    }
                });
            }
        }

        document.getElementById('back-to-modules').addEventListener('click', function() {
            gameState.currentModule = null;
            updateModuleCards();
            showScreen('screen-modules');
        });

        document.getElementById('back-to-modules-complete').addEventListener('click', function() {
            gameState.currentModule = null;
            updateModuleCards();
            showScreen('screen-modules');
        });

        // ä¸Šä¸€é¢˜æŒ‰é’®
        document.getElementById('prev-question').addEventListener('click', goToPrevQuestion);

        // ç»§ç»­ç­”é¢˜æŒ‰é’®
        document.getElementById('resume-question').addEventListener('click', resumeQuestion);

        document.getElementById('submit-answer').addEventListener('click', submitAnswer);

        document.getElementById('view-leaderboard-btn').addEventListener('click', function() {
            displayLeaderboard();
            showScreen('screen-leaderboard');
        });

        document.getElementById('view-leaderboard-complete').addEventListener('click', function() {
            displayLeaderboard();
            showScreen('screen-leaderboard');
        });

        document.getElementById('back-from-leaderboard').addEventListener('click', function() {
            showScreen('screen-modules');
        });

        document.getElementById('export-leaderboard').addEventListener('click', exportLeaderboard);

        document.getElementById('export-essay-btn').addEventListener('click', exportEssayAnswers);

        document.querySelectorAll('.leaderboard-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.leaderboard-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                displayLeaderboard(this.dataset.tab);
            });
        });

        document.getElementById('player-name').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') { document.getElementById('start-game').click(); }
        });
    </script>
</body>
</html>
